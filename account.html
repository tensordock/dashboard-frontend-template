<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Account - Cloud GPU Deployments</title>
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Include the necessary scripts and styles -->
    <link rel="stylesheet" href="./static/css/theme.bundle.css" />
    <link rel="stylesheet" href="./static/css/custom.css" />

  </head>
  <body>
    <div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content modal-content-black-text">
          <div class="modal-header">
            <h5 class="modal-title" id="depositModalLabel">Deposit
              Funds</h5>
            <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="deposit-form">
            <div class="modal-body">
              <label for="modalDepositAmount" class="form-label">Enter deposit amount:</label>
              <div class="input-group mb-3">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="modalDepositAmount" placeholder="Amount">
              </div>
            </div>
            <div id="payment-element" class="p-3"></div>
            <div class="modal-footer" id="deposit-footer">
              <button
                type="button"
                class="btn btn-falcon-primary"
                id="confirmDepositButton"
              >
                Confirm Amount
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <main>
      <div class="container" data-layout="container">
        <nav class="navbar navbar-light navbar-vertical navbar-expand-xl">
          <script>
            var navbarStyle = localStorage.getItem("navbarStyle");
            if (navbarStyle && navbarStyle !== 'transparent') {
              document.querySelector('.navbar-vertical').classList.add(`navbar-${navbarStyle}`);
            }
          </script>
          <div class="d-flex align-items-center">
            <a class="navbar-brand" href="/home">
              <div class="d-flex align-items-center py-3">
                <span class="font-sans-serif text-primary">GPUfleet</span>
              </div>
            </a>
          </div>
          <div class="collapse navbar-collapse" id="navbarVerticalCollapse">
            <div class="navbar-vertical-content scrollbar">
              <ul class="navbar-nav flex-column mb-3"
                  id="navbarVerticalNav">
                <li class="nav-item">
                  <a class="nav-link" href="/home" role="button">
                    <div
                            class="d-flex align-items-center"><span class="nav-link-icon"><svg class="svg-inline--fa fa-globe fa-w-16" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="globe" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"></path></svg><!-- <span class="fas fa-globe"></span> Font Awesome fontawesome.com --></span>
                      Home
                    </div>
                  </a>
                  <a class="nav-link" href="/list" role="button">
                    <div
                            class="d-flex align-items-center"><span class="nav-link-icon"><svg class="svg-inline--fa fa-window-restore fa-w-16" aria-hidden="true" focusable="false" data-prefix="far" data-icon="window-restore" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M464 0H144c-26.5 0-48 21.5-48 48v48H48c-26.5 0-48 21.5-48 48v320c0 26.5 21.5 48 48 48h320c26.5 0 48-21.5 48-48v-48h48c26.5 0 48-21.5 48-48V48c0-26.5-21.5-48-48-48zm-96 464H48V256h320v208zm96-96h-48V144c0-26.5-21.5-48-48-48H144V48h320v320z"></path></svg><!-- <span class="far fa-window-restore"></span> Font Awesome fontawesome.com --></span>
                      Virtual machines
                    </div>
                  </a>
                  <a class="nav-link" href="/account" role="button">
                    <div
                            class="d-flex align-items-center"><span class="nav-link-icon"><svg class="svg-inline--fa fa-user fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="user" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-41.6c0-74.2-60.2-134.4-134.4-134.4z"></path></svg><!-- <span class="fas fa-user"></span> Font Awesome fontawesome.com --></span>
                      Account
                    </div>
                  </a>
                  <a class="nav-link" href="/deploy" role="button">
                    <div class="d-flex align-items-center">
                            <span class="nav-link-icon">
                                <svg class="svg-inline--fa fa-rocket fa-w-16" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rocket" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
                                    <path fill="currentColor" d="M505.12019,19.09375c-1.18945-5.53125-6.65819-11-12.207-12.1875C460.716,0,435.507,0,410.40747,0,307.17523,0,245.26909,55.20312,199.05238,128H94.83772c-16.34763.01562-35.55658,11.875-42.88664,26.48438L2.51562,253.29688A28.4,28.4,0,0,0,0,264a24.00867,24.00867,0,0,0,24.00582,24H127.81618l-22.47457,22.46875c-11.36521,11.36133-12.99607,32.25781,0,45.25L156.24582,406.625c11.15623,11.1875,32.15619,13.15625,45.27726,0l22.47457-22.46875V488a24.00867,24.00867,0,0,0,24.00581,24,28.55934,28.55934,0,0,0,10.707-2.51562l98.72834-49.39063c14.62888-7.29687,26.50776-26.5,26.50776-42.85937V312.79688c72.59753-46.3125,128.03493-108.40626,128.03493-211.09376C512.07526,76.5,512.07526,51.29688,505.12019,19.09375ZM384.04033,168A40,40,0,1,1,424.05,128,40.02322,40.02322,0,0,1,384.04033,168Z">
                                    </path>
                                </svg><!-- <span class="fas fa-rocket"></span> Font Awesome fontawesome.com -->
                            </span>Deploy servers
                    </div>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
        <div class="content">
          <nav class="navbar navbar-light navbar-glass navbar-top navbar-expand">
            <a class="navbar-brand me-1 me-sm-3" href="../../index.html">
              <div class="d-flex align-items-center">
                <span class="font-sans-serif text-primary">GPUfleet</span>
              </div>
            </a>
            <ul class="navbar-nav navbar-nav-icons ms-auto flex-row align-items-center">
              <li class="nav-item dropdown">
                <a
                  class="nav-link pe-0 ps-2"
                  id="navbarDropdownUser"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="true"
                >
                  <svg class="svg-inline--fa fa-user-circle fa-w-16 text-900 fs-6" aria-hidden="true" focusable="false" data-prefix="far" data-icon="user-circle" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M248 104c-53 0-96 43-96 96s43 96 96 96 96-43 96-96-43-96-96-96zm0 144c-26.5 0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm0-240C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-49.7 0-95.1-18.3-130.1-48.4 14.9-23 40.4-38.6 69.6-39.5 20.8 6.4 40.6 9.6 60.5 9.6s39.7-3.1 60.5-9.6c29.2 1 54.7 16.5 69.6 39.5-35 30.1-80.4 48.4-130.1 48.4zm162.7-84.1c-24.4-31.4-62.1-51.9-105.1-51.9-10.2 0-26 9.6-57.6 9.6-31.5 0-47.4-9.6-57.6-9.6-42.9 0-80.6 20.5-105.1 51.9C61.9 339.2 48 299.2 48 256c0-110.3 89.7-200 200-200s200 89.7 200 200c0 43.2-13.9 83.2-37.3 115.9z"></path></svg>
                </a>
                <div
                  class="dropdown-menu dropdown-caret dropdown-menu-end py-0"
                  aria-labelledby="navbarDropdownUser"
                  data-popper="static"
                >
                  <div class="bg-white dark__bg-1000 rounded-2 py-2">
                    <a class="dropdown-item" href="/account">Account</a>
                    <a class="dropdown-item" href="#" onclick="document.cookie='whitelabelToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'; window.location.href='/home'">Logout</a>
                  </div>
                </div>
              </li>
            </ul>
          </nav>
          <div class="card overflow-hidden mb-3">
            <div class="card-body position-relative">
              <h2>Account settings</h2>
              <p>
                Manage your GPUfleet account.
                <a class="btn btn-link ps-0 btn-sm" href="/support.html">
                Have questions? Chat with us</a>
              </p>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-header">
              <h5 class="mb-0">Profile</h5>
            </div>
            <div class="card-body bg-body-tertiary">
              <form class="row g-3">
                <div class="col-lg-6">
                  <label class="form-label" for="user-id">User ID</label>
                  <input class="form-control" id="user-id" type="text" value="Loading..." disabled>
                </div>
                <div class="col-lg-6">
                  <label class="form-label" for="organization-id">Organization ID</label>
                  <input class="form-control" id="organization-id" type="text" value="Loading..." disabled>
                </div>
                <div class="col-lg-6">
                  <label class="form-label" for="user-email">Email</label>
                  <input class="form-control" id="user-email" type="text" value="Loading..." disabled>
                </div>
                <div class="col-lg-6">
                  <label class="form-label" for="organization-name">Organization name</label>
                  <input class="form-control" id="organization-name" type="text" value="Loading..." disabled>
                </div>
                <div class="col-lg-6">
                  <label class="form-label" for="organization-type">Organization type</label>
                  <input class="form-control" id="organization-type" type="text" value="Loading..." disabled>
                </div>
                <div class="col-lg-6">
                  <label class="form-label" for="account-balance">Account balance</label>
                  <input class="form-control" id="account-balance" type="text" value="Loading..." disabled>
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <a type="button" class="btn btn-falcon-primary lift mb-2"
                     data-toggle="modal"
                     data-target="#depositModal" role="button" id="depositButton">
                    Deposit Funds
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const stripe = Stripe('pk_test_51JqNQYHSshR0IOtvWv45wVZic3eTs6q5px6NaaqmbVXOAOSPCw7mAPTqS3HDK0tzXBJLKdwDrtkGT5cukjjAbfCK00BVmUO4oD');
      let stripeElements;

      document.addEventListener("DOMContentLoaded", async function() {
        const baseUrl = 'http://localhost:5000';
        let loggedIn = false;
        const userInfo = { email: '', orgName: '' };

        const whitelabelToken = document.cookie.split('; ').find(row => row.startsWith('whitelabelToken='));

        if (whitelabelToken) {
          try {
            const response = await fetch(`${baseUrl}/api/v0/client/whitelabel/token_verify`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': whitelabelToken.split('=')[1],
              },
            });

            if (response.ok) {
              const tokenVerifyResponse = await response.json();
              loggedIn = true;
              userInfo.email = tokenVerifyResponse.email;
              userInfo.orgName = tokenVerifyResponse.org_name;
            }
          } catch (error) {
            window.location.href = './login';
          }
        }
          await getAccountInfo();
      });

     const baseUrl = 'http://localhost:5000';
     const whitelabelToken = document.cookie.split('; ').find(row => row.startsWith('whitelabelToken='));

     const getAccountInfo = async () => {
        try {
          const response = await fetch(`${baseUrl}/api/vO/client/whitelabel/getUserInfo`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': whitelabelToken.split('=')[1]
            },
          });

          if (response.ok) {
            const userInquiryResponse = await response.json();
            console.log("Data", userInquiryResponse);

            document.getElementById('account-balance').value = `$${userInquiryResponse.balance}`;
            document.getElementById('user-id').value = userInquiryResponse.uuid;
            document.getElementById('user-email').value = userInquiryResponse.email;
            document.getElementById('organization-id').value = userInquiryResponse.organization;
            document.getElementById('organization-name').value = userInquiryResponse.organization_name;
            document.getElementById('organization-type').value = userInquiryResponse.organization_type;

            const membersList = document.getElementById('organization-members-list');
            const members = userInquiryResponse.members;

            console.log("org name: ", userInquiryResponse.organization_name);
          }
        } catch (error) {
          console.error("Error verifying token:", error);
          showMessage("Error retrieving account information", true);
          return "Error getting information";
        }
      };
      const showMessage = (message, isError = true) => {
          const messageBox = document.getElementById('messageBox');
          messageBox.style.display = 'block';
          messageBox.textContent = message;
          messageBox.className = isError ? 'alert alert-danger' : 'alert alert-success';
      };

      const depositFunds = () => {
        const amount = document.getElementById('modalDepositAmount').value;

        if (amount !== null && Number(amount) >= 0) {
            fetch(`http://localhost:5000/api/v0/client/whitelabel/deposit`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': whitelabelToken.split('=')[1],
              },
              body: JSON.stringify({ amount }),
            })
            .then((response) => {
              if (!response.ok) throw new Error('Network response was not ok');
              return response.json();
            })
            .then((data) => {
              stripeElements = stripe.elements({ clientSecret: data.client_secret });

              const paymentElement = stripeElements.create('payment');
              paymentElement.mount('#payment-element');

              document.getElementById("deposit-footer").innerHTML = `
                 <button
                  class="btn btn-falcon-primary"
                  id="confirmDepositButton"
                  type="submit"
                >
                   Deposit Funds
                </button>
              `;
            })
            .catch(function (error) {
              console.error("Error:", error);
              showMessage("Error: unable to open session");
            });
        } else {
          showMessage("Invalid deposit amount");
        }
      }

      document.getElementById('confirmDepositButton').addEventListener('click', function() {
        depositFunds();
      });

      const form = document.getElementById('deposit-form');
      let submitted = false;

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        if(submitted) { return; }

        submitted = true;

        form.querySelector('button').disabled = true;

        stripe.confirmPayment({
          elements: stripeElements,
          confirmParams: {
            return_url: `${window.location.origin}/account`,
          }
        });
      });
  </script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
